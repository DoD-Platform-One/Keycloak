istio:
  enabled: true
  keycloak:
    enabled: true

replicas: 1

extraVolumes: |
  - name: certificates
    secret:
      secretName: {{ include "keycloak.fullname" . }}-certificates
  - name: customreg
    secret:
      secretName: {{ include "keycloak.fullname" . }}-customreg
  - name: realm
    secret:
      secretName: {{ include "keycloak.fullname" . }}-realm

extraVolumeMounts: |
  - name: certificates
    mountPath: /etc/x509/https
    readOnly: true
  - name: customreg
    mountPath: /opt/jboss/keycloak/customreg.yaml
    subPath: customreg.yaml
    readOnly: true
  - name: realm
    mountPath: /opt/jboss/keycloak/realm.json
    subPath: realm.json
    readOnly: true

# - KEYCLOAK_USER/KEYCLOAK_PASSWORD: credentials for admin user to be created
# - PROXY_ADDRESS_FORWARDING: See https://github.com/codecentric/helm-charts/tree/master/charts/keycloak#running-keycloak-behind-a-reverse-proxy
# - JGROUPS_*, KEYCLOAK_SERVICE_DNS_NAME, CACHE_OWNERS: For HA/Clustering.  See https://github.com/codecentric/helm-charts/tree/master/charts/keycloak#high-availability-and-clustering
extraEnv: |
  - name: JAVA_TOOL_OPTIONS
    value: -XX:+UseContainerSupport -XX:MaxRAMPercentage=50.0
  - name: KEYCLOAK_USER
    valueFrom:
      secretKeyRef:
        key: adminuser
        name: {{ include "keycloak.fullname" . }}-credentials
  - name: KEYCLOAK_PASSWORD
    valueFrom:
      secretKeyRef:
        key: password
        name: {{ include "keycloak.fullname" . }}-credentials
  - name: PROXY_ADDRESS_FORWARDING
    value: "true"
  - name: X509_CA_BUNDLE
    value: /etc/x509/https/cas.pem
  - name: JGROUPS_DISCOVERY_PROTOCOL
    value: dns.DNS_PING
  - name: JGROUPS_DISCOVERY_PROPERTIES
    value: 'dns_query={{ include "keycloak.serviceDnsName" . }}'
  - name: KEYCLOAK_SERVICE_DNS_NAME
    value: '{{ include "keycloak.serviceDnsName" . }}'
  - name: CACHE_OWNERS_COUNT
    value: "2"
  - name: CACHE_OWNERS_AUTH_SESSIONS_COUNT
    value: "2"
  - name: CUSTOM_REGISTRATION_CONFIG
    value: /opt/jboss/keycloak/customreg.yaml
  - name: KEYCLOAK_IMPORT
    value: /opt/jboss/keycloak/realm.json

secrets:
  # Default admin user credentials
  credentials:
    stringData:
      adminuser: admin
      password: password
  # Mutual TLS certificates
  # The values below are for development and should not be used in production
  certificates:
    stringData:
      tls.crt: '{{ .Files.Get "resources/dev/tls.crt" }}'
      tls.key: '{{ .Files.Get "resources/dev/tls.key" }}'
      cas.pem: '{{ .Files.Get "resources/dod_cas.pem" }}'
  # Custom realm configuration
  customreg:
    stringData:
      customreg.yaml: '{{ .Files.Get "resources/dev/baby-yoda.yaml" }}'
  # Custom realm configuration
  realm:
    stringData:
      realm.json: '{{ .Files.Get "resources/dev/baby-yoda.json" }}'

startupScripts:
  bigbang.cli: |
    {{- .Files.Get "scripts/bigbang.cli" }}
